<script>
const API_BASE = "/api";
let currentUser = "Initiate";

// Load user data
async function loadDashboard() {
  try {
    const res = await fetch(`${API_BASE}/getUserData?username=${currentUser}`);
    const data = await res.json();

    document.getElementById("userPFP").src = data.pfp || "";
    document.getElementById("usernameDisplay").value = data.username || currentUser;
    document.getElementById("displayName").textContent = data.displayName || currentUser;
    document.getElementById("userLevel").textContent = data.level || 1;

    const legendaryList = document.getElementById("legendaryList");
    legendaryList.innerHTML = "";
    (data.items || []).forEach(item => {
      const div = document.createElement("div");
      div.className = "item-box";
      div.textContent = item;
      legendaryList.appendChild(div);
    });

    const questList = document.getElementById("questList");
    questList.innerHTML = "";
    (data.quests || []).forEach(q => {
      const li = document.createElement("li");
      li.textContent = q;
      questList.appendChild(li);
    });

    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";
    (data.chat || []).forEach(c => {
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<strong>${c.user}:</strong> ${c.text}`;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;

  } catch (err) {
    console.error("Failed to load dashboard", err);
  }
}

// Update PFP
document.getElementById("updatePFPBtn").addEventListener("click", async () => {
  const newPFP = prompt("Enter new profile picture URL:");
  document.getElementById("userPFP").src = newPFP;

  await fetch(`${API_BASE}/saveTraits`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: currentUser, pfp: newPFP })
  });
});

// Send chat
document.getElementById("sendBtn").addEventListener("click", async () => {
  const msgInput = document.getElementById("chatInput");
  const text = msgInput.value.trim();
  if (!text) return;

  const res = await fetch(`${API_BASE}/saveChat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: currentUser, text })
  });
  if (res.ok) {
    const chatBox = document.getElementById("chatBox");
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `<strong>${currentUser}:</strong> ${text}`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    msgInput.value = "";
  }
});

window.addEventListener("DOMContentLoaded", loadDashboard);
</script>
